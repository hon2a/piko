var Chaos = require('Chaos'),
	HTTP = require('http-status'),
	validation = require('validation'),
	util = require('util'),
	fn = require('functions');

var validator = module.exports = function (config) {
	
	return function (req, res, action, next) {
		if (config[action] || config.all) {
			var cfg = fn.merge({}, config[action] || {}, config.all),
				actions = new Chaos(),
				keys = Object.keys(req.data || {});
			keys.forEach(function (value, key) {
				var valiCfg = cfg[key];
				if (valiCfg) {
					actions.add(function (callback) {
						validation.validate(valiCfg, value, callback);
					});
					delete cfg[key];	// remove used config to find missing items
				} else if (valiCfg !== false) {
					delete req.data[key];
				}
			});

			actions.run(function (err, results) {
				if (err) {
					res.send(util.format('Invalid value of argument %s. %s',
							fn.quote(keys[results.length]), err), HTTP.BAD_REQUEST);
				} else {
					var missing = Object.keys(cfg);
					if (missing.length) {
						res.send(util.format('Missing mandatory arguments %s.',
								missing.map(fn.quote).join(', ')), HTTP.BAD_REQUEST);
					} else {
						next();
					}
				}
			});
		} else {
			next();
		}
	};
};