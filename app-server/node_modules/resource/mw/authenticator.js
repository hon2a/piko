var HTTP = require('http-status'),
	expandConfig = require('../expandConfig'),
	fn = require('functions');

var authenticator = module.exports = function (config) {
	config = expandConfig(config);
	
	return function (req, res, action, next) {
		var auth = config[action],
			checkPermissions = function (auth) {
				if (auth) {
					if (req.access) {
						if (fn.isString(auth) && !req.access.can[auth]) {
							res.send('Insufficient permissions.', HTTP.FORBIDDEN);
						} else {
							next();
						}
					} else {
						res.send('Not signed in.', HTTP.FORBIDDEN);
					}
				} else {
					next();
				}
			};
		if (fn.isFunction(auth)) {
			auth(req, function (err, newAuth) {
				if (err) {
					res.finish(err);
				} else {
					checkPermissions(newAuth);
				}
			});
		} else {
			checkPermissions(auth);
		}
	};
};