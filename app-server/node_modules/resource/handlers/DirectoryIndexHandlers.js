var ResourceHandlers = require('./ResourceHandlers'),
	HTTP = require('http-status'),
	fs = require('fs');

var DirectoryIndexHandlers = module.exports = ResourceHandlers.extend({

	constructor: function (config) {
		this.base(fn.merge({
			path: null	// mandatory
		}, config));
	},
	
	fillPath: function (req, callback) {
		var path = [],
			partial = false;
		this.config.path.split('/').forEach(function (part, i) {
			if (!partial) {
				if (part.match(/^:/)) {
					part = req.params[part.slice(1)];
					if (part) {
						path.push(part);
					} else {
						partial = true;
					}
				} else {
					path.push(part);
				}
			}
		});
		callback(null, path.join('/'), partial);
	},

// handler methods

	index: function (req, res) {
		this.fillPath(req, function (err, path, partial) {
			fs.readdir(path, function (err, files) {
				res.send(path);return;
				if (err && (err.code === 'ENOENT')) {
					res.send(HTTP.NOT_FOUND);
				} else {
					res.finish(err, files);
				}
			});
		});
	}

});