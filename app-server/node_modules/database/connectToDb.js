var connectToDb = module.exports = function (options) {
	var connection = null,
		connect = function (callback) {
			if (connection === null) {
				connection = options.factory.createConnection(options.config);
				connection.connect(callback);
			} else {
				reconnect(callback);
			}
		},
		disconnect = function (callback) {
			if (connection !== null) {
				connection.end(callback);
				connection = null;
			} else {
				callback();
			}
		},
		reconnect = function (callback) {
			disconnect(function (err) {
				if (err) {
					callback(err);
				} else {
					connect(callback);
				}
			});
		};

	return {
		close: disconnect,

		query: function (queryCode, values, callback) {
			var cb = (typeof values === 'function') ? values : callback,
				query = function () {
					connection.query(queryCode, values, callback);
				};

			if (connection !== null) {
				query();
			} else {
				connect(function (err) {
					if (err) {
						cb(err);
					} else {
						query();
					}
				});
			}
		},

		useDb: function (db, callback) {
			options.config.database = db;
			if (connection !== null) {
				reconnect(callback);
			}
		}
	};
};
